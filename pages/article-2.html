<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Compliance as Code - Samuel Aydlette</title>
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/animations.css">
    <link rel="stylesheet" href="/assets/css/articles.css">
    <link rel="stylesheet" href="/assets/css/mobile.css">
</head>
<body>
    <header class="header">
        <h1>Sam Aydlette</h1>
        <p>Author and Cybersecurity Practitioner</p>
    </header>

    <div class="main-container">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-header">
            <h1><a href="/index.html" style="text-decoration: none; color: inherit;">Sam Aydlette</a></h1>
            <p>Author and Cybersecurity Practitioner</p>
        </div>
        <div class="nav-grid">
            <a href="/pages/books.html" class="nav-button">Books</a>
            <a href="/pages/articles.html" class="nav-button">Articles</a>
            <a href="/pages/about.html" class="nav-button">About</a>
            <a href="/pages/contact.html" class="nav-button">Contact</a>
        </div>
    </nav>

        <!-- Main Content -->
        <main class="content">
            <article class="article-card">
                <div class="article-meta">
                    <span class="article-date">February 1, 2025</span>
                    <span class="article-category">Cloud Security</span>
                </div>
                <h2 class="section-title">Building a Compliance Automation Pipeline in AWS For Less than $5000</h2>
                
                <div class="article-content">
                    <div class="disclaimer">
                        The views and opinions expressed in this article are those of the author and do not reflect the views of any organization or employer.
                    </div>
                    <div class="article-summary">
                        As organizations continue to migrate their infrastructure to the cloud and address technical debt from legacy cloud infrastructures, achieving and maintaining compliance has become increasingly complex and expensive. But it doesn't have to be. In this article, I'll share my experience implementing a compliance-as-code approach in AWS, focusing on automated security controls and continuous compliance monitoring. This approach saves enormous amounts of time and money.                    </div>
                    <p></p>
                    <h3>The Foundation: Infrastructure as Code</h3>
                    <p>Control Tower serves as the core AWS service for establishing a secure multi-account architecture. Begin by setting up Control Tower to create your landing zone, which automatically configures your management account, security account, and log archive account following AWS best practices. Use Organizations to implement a hierarchical structure with Organizational Units (OUs) for different environments (Dev, Prod, etc.) and workload types. IAM Identity Center integration with Control Tower provides centralized access management and federated authentication across all accounts.</p>
                    <p>Implement AWS CloudFormation with resource tagging using a standardized metaschema to ensure consistent resource tracking and compliance. Define your metaschema to include mandatory tags such as Environment, CostCenter, DataClassification, and ComplianceFramework. Create custom CloudFormation hooks to enforce tagging compliance during resource creation. Use the AWS CDK to develop infrastructure as code, implementing these standards programmatically. Below is an example of CDK code:</p>
                        <div class="code-block">
                            <pre><code>
                            const tagValidation = new CustomResource(this, 'TagValidation', {
                              serviceToken: tagValidationFunction.functionArn,
                              properties: {
                                requiredTags: ['Environment', 'CostCenter', 'DataClassification'],
                                resourceType: 'AWS::S3::Bucket'
                                }
                            });
                            </code></pre>
                        </div>
                    
                    <h3>The Pipeline: Configuration-as-Code Using Config</h3>
                    <p>Deploy Config rules across all accounts using conformance packs aligned with NIST 800-53 controls. AWS provides many conformance packs, or create a custom conformance pack that incorporates both AWS-managed and custom rules. Below is an example conformance pack configuration in yaml:</p>
                    <div class="code-block">
                        <pre><code>
                        Resources:
                        NISTBaselineConformancePack:
                            Type: AWS::Config::ConformancePack
                            Properties:
                            ConformancePackName: nist-800-53-baseline
                            TemplateBody: |
                                Parameters:
                                AccessControlPolicy:
                                    Type: String
                                Resources:
                                IAMPasswordPolicy:
                                    Type: AWS::Config::ConfigRule
                                    Properties:
                                    ConfigRuleName: iam-password-policy
                                    Source:
                                        Owner: AWS
                                        SourceIdentifier: IAM_PASSWORD_POLICY
                        </code></pre>
                    </div>
                    <h3>Control Validation: Verifying Implementation Using Security Hub</h3>
                    <p>Implement AWS Security Hub in your security account and enable it as a delegated administrator for your organization. Configure Security Hub to aggregate findings from GuardDuty, Config, and any custom security tools (SAST/DAST/SCA, Vulnerability Scanners, etc.). Create custom Lambda functions to automate security responses, such as quarantining compromised resources or rotating exposed credentials. Below is an example Lambda function written in python:</p>
                    <div class="code-block">
                        <pre><code>
                        def handle_security_finding(event, context):
                            finding = event['detail']['findings'][0]
                            if finding['Severity']['Label'] == 'CRITICAL':
                                account_id = finding['AwsAccountId']
                                resource_id = finding['Resources'][0]['Id']
                                remediate_finding(account_id, resource_id)
                        </code></pre>
                    </div>
                    <h3>Control Monitoring: Monitoring Implementation Drift Using GuardDuty and EventBridge</h3>
                    <p>Configure GuardDuty across all accounts with the security account as the delegated administrator. Set up custom threat detection by implementing Lambda functions that process GuardDuty findings and correlate them with other security events. Use Security Hub as the central dashboard for security findings, with custom insights for specific compliance requirements and security metrics. Use Malware Analytics to cover AntiVirus.
                        Create automated response workflows using EventBridge rules and Lambda functions. Implement a tagging-based security response system where resources with specific compliance requirements receive automated remediation based on their tags. Example EventBridge rule in json:</p>
                    <div class="code-block">
                        <pre><code>
                        {
                            "source": ["aws.securityhub"],
                            "detail-type": ["Security Hub Findings - Imported"],
                            "detail": {
                                "findings": [{
                                "Severity": [{
                                    "Label": ["CRITICAL"]
                                }],
                                "Tags": [{
                                    "Key": ["ComplianceFramework"],
                                    "Value": ["NIST800-53"]
                                }]
                                }]
                            }
                        }
                        </code></pre>
                    </div>
                    <h3>Putting It All Together using GitOps</h3>
                    <p>Use GitHub for version control of your infrastructure code, implementing branch protection rules and required reviews for all infrastructure changes. Set up GitHub Actions workflows to automatically validate CloudFormation templates and CDK code before deployment using yaml:</p>
                    <div class="code-block">
                        <pre><code>
                        name: Infrastructure Validation
                        on:
                        pull_request:
                            paths:
                            - 'infrastructure/**'
                        jobs:
                        validate:
                            runs-on: ubuntu-latest
                            steps:
                            - uses: actions/checkout@v2
                            - name: Set up Node.js
                                uses: actions/setup-node@v2
                            - name: Install dependencies
                                run: npm install
                            - name: Synthesize CDK app
                                run: npx cdk synth
                            - name: Validate CloudFormation
                                run: |
                                  for template in cdk.out/*.template.json; do
                                    aws cloudformation validate-template --template-body file://$template
                                  done
                        </code></pre>
                    </div>

                    <h3>Additional Security Measures</h3>
                    <p>Regularly review and update your security controls to maintain alignment with NIST 800-53 requirements. Implement a change management process that includes security review gates and automated compliance checks. Use AWS Organizations Service Control Policies (SCPs) to enforce security guardrails across all accounts:</p>
                    <div class="code-block">
                        <pre><code>
                        {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                "Sid": "RequireResourceTags",
                                "Effect": "Deny",
                                "Action": [
                                    "s3:CreateBucket",
                                    "ec2:RunInstances"
                                ],
                                "Resource": "*",
                                "Condition": {
                                    "Null": {
                                    "aws:RequestTag/Environment": "true",
                                    "aws:RequestTag/CostCenter": "true",
                                    "aws:RequestTag/DataClassification": "true"
                                    }
                                }
                                }
                            ]
                        }
                        </code></pre>
                    </div>

                    <p>Monitor and analyze Security Hub findings, GuardDuty alerts, and Config rules across all accounts to identify security trends and areas for improvement. Create custom dashboards in CloudWatch to track security metrics and compliance status. Implement automated reporting using Lambda functions that generate compliance reports and distribute them to stakeholders via an automated ticketing system.</p>
                    <p></p>
                    <p>And that's it, folks! The above approach potentially costs less than $5,000 annually for a  SaaS running on serverless infrastructure.</p>
                </div>
            </article>
        </main>
    </div>

    <footer>
        <p>&copy; 2024 Samuel Aydlette. All rights reserved.</p>
        <div class="social-links">
            <a href="https://www.linkedin.com/in/sa2/">LinkedIn</a>
        </div>
    </footer>
    <script type="module" src="/assets/js/main.js"></script>
</body>
</html>
